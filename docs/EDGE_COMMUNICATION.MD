# Edge Device ↔ Supabase Contract

This document defines how the edge computer (YOLOv5 pipeline + ESP32 controller) interacts with Supabase during a recycling session. It covers data flow, API payloads, and expected responses so that the camera classification service, hardware controller, and kiosk UI stay in sync.

## Supabase Client Credentials
- Use the **service role key** (`SUPABASE_SERVICE_KEY`) for server-to-server communication. Never ship the anon key on the edge device.
- Set the base URL (`SUPABASE_URL`). For local development against the hosted instance you can reuse the values in `.env.local`.
- All requests should include the `apikey` header set to the service key. When calling Edge Functions via HTTP, also set `Authorization: Bearer <service-key>`.

## Active Session Discovery
1. Subscribe to the Supabase Realtime channel `public:sessions` filtered by `status = 'active'` and the edge device label you manage (e.g., `edge_device_id` or metadata tag).
2. Alternatively, poll the REST API:
   ```http
   GET /rest/v1/sessions?status=eq.active&edge_device_id=eq.<DEVICE_UUID>&select=id,profile_id,started_at,total_cents
   apikey: <SERVICE_KEY>
   Authorization: Bearer <SERVICE_KEY>
   ```
3. Cache the `session.id` locally; all subsequent item submissions use this identifier.

If no active session exists, pause classification and wait for the kiosk to initiate a new one.

## Recording a Classified Item
Call the Supabase Edge Function `record-item` each time an item is identified.

### Request
```
POST /functions/v1/record-item
apikey: <SERVICE_KEY>
Authorization: Bearer <SERVICE_KEY>
Content-Type: application/json

{
  "sessionId": "<SESSION_UUID>",
  "categorySlug": "bottle",
  "confidence": 0.92,
  "rawPayload": {
    "model": "yolov5n",
    "confidence": 0.923,
    "frame": "s3://.../timestamp.jpg"
  },
  "clientRef": "<OPTIONAL_UUID_FROM_EDGE>",
  "amountOverrideCents": 10
}
```
- `sessionId` (required): the active session UUID.
- `categorySlug` (required): matches a row in `categories.slug` (`can`, `bottle`, `garbage`, etc.).
- `confidence` (optional): floating-point 0–1.
- `rawPayload` (optional): JSON dump of the model output, serial telemetry, etc.
- `clientRef` (optional but recommended): UUID generated by the edge device to make retries idempotent.
- `amountOverrideCents` (optional): override the per-category payout when hardware detects special cases. Leave `null` to use the default deposit amount.

### Response
```json
{
  "result": {
    "session_item": {
      "id": "...",
      "session_id": "...",
      "category_id": "...",
      "amount_cents": 10,
      "confidence": 0.92,
      "detected_at": "2025-10-04T23:40:12.514Z",
      "raw_payload": { "model": "yolov5n", "confidence": 0.923 },
      "client_ref": "..."
    },
    "transaction": {
      "id": "...",
      "profile_id": "...",
      "session_id": "...",
      "amount_cents": 10,
      "type": "deposit",
      "created_at": "2025-10-04T23:40:12.518Z"
    },
    "category": {
      "id": "...",
      "slug": "bottle",
      "display_name": "Plastic Bottle",
      "deposit_cents": 10,
      "routing_slot": 2
    },
    "session": {
      "id": "...",
      "profile_id": "...",
      "total_cents": 240,
      "status": "active"
    }
  }
}
```
- `session_item`: canonical record of the deposit. Save the `id` if you need to reconcile later.
- `transaction`: ledger entry that credited the user balance. Can be `null` when amount is zero (e.g., garbage).
- `category`: metadata to instruct the ESP32 (e.g., `routing_slot`).
- `session`: current session totals. You can mirror `total_cents` into your UI/logs.

### Error Handling
- `404`: session or category not found. Stop processing until kiosk starts a new session or fix the slug.
- `409`: session not active (`status` changed). Clear your active session cache and wait for a new one.
- `400`: payload validation failed—check the error message.
- `500`: unexpected failure; safe to retry with the same `clientRef`.

## Receiving Updates
The kiosk UI listens to realtime inserts on `session_items` and updates on `profiles`. The edge can optionally subscribe to the same channels to monitor system health:
- `public:session_items` filtered by the active session to confirm the item landed.
- `public:profiles` filtered by the user ID to confirm balance adjustments.

## Session Closure
When the kiosk or edge determines a session should end, call the `close-session` Edge Function:
```
POST /functions/v1/close-session
{
  "sessionId": "<SESSION_UUID>",
  "status": "complete" | "expired" | "error"
}
```
Use `status = "expired"` when the inactivity timer triggers on the edge side. The function returns the updated session row.

## Summary Checklist
1. Subscribe for active session changes (Realtime or poll).
2. Maintain the current `sessionId` locally.
3. For each classified item:
   - Build payload with `sessionId`, `categorySlug`, `confidence`, `rawPayload`, optional `clientRef`.
   - POST to `/functions/v1/record-item` with service headers.
   - Act on the response (`category.routing_slot` for hardware routing, `transaction` for logs).
4. On session end or timeout, POST to `/functions/v1/close-session` and clear state.

Following this contract keeps the kiosk UI, edge device, and Supabase ledger in lockstep while preserving idempotency and avoiding duplicate credits.
